<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Arise Tax ‚Äî QBO Report Package Generator (Merged)</title>
  <style>
    :root{
      --brand-bg: #0f172a;
      --brand-surface: #0b1220;
      --brand-primary: #1e3a8a;
      --brand-primary-600: #1d4ed8;
      --brand-ring: #60a5fa;
      --text-strong: #111827;
      --text: #1f2937;
      --text-subtle: #6b7280;
      --surface: #ffffff;
      --surface-2: #f8fafc;
      --line: #e5e7eb;
      --ok: #16a34a;
      --warn: #f59e0b;
      --bad: #dc2626;
      --shadow-lg: 0 20px 40px rgba(2,6,23,.12), 0 6px 20px rgba(2,6,23,.08);
      --shadow-md: 0 12px 24px rgba(2,6,23,.10), 0 4px 12px rgba(2,6,23,.06);
      --radius-xl: 18px;
      --radius-2xl: 22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 600px at -10% -10%, rgba(30,58,138,.25), transparent 60%),
        radial-gradient(1000px 600px at 110% -20%, rgba(29,78,216,.18), transparent 55%),
        linear-gradient(180deg, var(--brand-surface), #0b1022 60%);
      color: var(--text);
      -webkit-font-smoothing: antialiased; 
      -moz-osx-font-smoothing: grayscale;
    }
    .wrap{max-width:1200px;margin:40px auto;padding:0 24px}
    .shell{
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-lg);
      overflow:hidden;
    }
    .hero{
      display:grid; 
      grid-template-columns: 1fr; 
      gap: 24px;
      padding: 48px 36px; 
      background: linear-gradient(180deg, #ffffff, #f9fafb);
      border-bottom: 1px solid var(--line);
    }
    .brand{
      display:flex;align-items:center;justify-content:center;
      width:180px;height:100px;margin:0 auto 8px auto;
      background:#0f172a; color:#fff; border-radius:14px;
      font-weight:800; letter-spacing:3px; font-size:28px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .hero h1{margin:8px 0 6px 0; text-align:center; font-size:28px; color:var(--text-strong)}
    .hero p{margin:0; text-align:center; color:var(--text-subtle)}
    .section{padding:32px 36px}
    .feature-grid{display:grid; gap:16px; grid-template-columns: repeat(auto-fit,minmax(260px,1fr))}
    .feature{
      background: var(--surface-2);
      border:1px solid var(--line);
      border-radius: 14px; padding:16px 18px;
    }
    .feature h4{margin:0 0 10px 0; color: var(--brand-primary); font-size:15px}
    .feature li{color:#374151; margin:6px 0}
    .subtle-card{
      background: var(--surface-2);
      border:1px solid var(--line);
      border-radius: var(--radius-xl);
      padding: 24px;
    }
    .drop{
      border: 2px dashed #cbd5e1;
      border-radius: var(--radius-2xl);
      padding:48px; text-align:center; background: #f8fafc;
      transition:.2s ease; position:relative;
    }
    .drop.dragover{border-color: var(--brand-primary); background:#f1f5f9}
    .u-btn{
      appearance:none; border:1px solid var(--brand-primary);
      background: var(--brand-primary);
      color:#fff; font-weight:700; letter-spacing:.3px;
      padding:14px 22px; border-radius:999px; cursor:pointer;
      box-shadow: var(--shadow-md);
      transition: transform .08s ease, background .15s ease;
    }
    .u-btn:hover{background: var(--brand-primary-600)}
    .u-btn:active{transform: translateY(1px)}
    .u-btn:focus{outline:none; box-shadow:0 0 0 4px rgba(96,165,250,.5)}
    .file-list{margin-top:18px}
    .file{
      display:flex; align-items:center; justify-content:space-between;
      background:#fff; border:1px solid var(--line); border-radius:14px;
      padding:14px 16px; margin:10px 0;
    }
    .pill{font-size:11px; font-weight:800; border-radius:999px; padding:6px 10px; letter-spacing:.3px}
    .pill.pl{background:#e2fbe8; color:#166534; border:1px solid #bbf7d0}
    .pill.bs{background:#e0e7ff; color:#3730a3; border:1px solid #c7d2fe}
    .pill.ar{background:#fef9c3; color:#854d0e; border:1px solid #fde68a}
    .pill.ap{background:#fee2e2; color:#991b1b; border:1px solid #fecaca}
    .pill.ch{background:#dcfce7; color:#065f46; border:1px solid #a7f3d0}
    .danger{background:#ef4444; color:#fff; border:none}
    .danger:hover{background:#dc2626}
    .grid{display:grid; gap:18px}
    .grid.two{grid-template-columns: repeat(auto-fit, minmax(260px,1fr))}
    label{display:block; font-weight:600; color:#334155; margin: 6px 0}
    input[type="text"], input[type="date"], input[type="color"], textarea{
      width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:12px;
      background:#fff; color: var(--text);
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    textarea{min-height:120px; resize:vertical}
    input:focus, textarea:focus{
      outline:none; border-color: var(--brand-primary);
      box-shadow: 0 0 0 4px rgba(96,165,250,.35);
    }
    .primary{
      width:100%; padding:18px 26px; border-radius:999px;
      border:1px solid var(--brand-primary); background:var(--brand-primary);
      color:#fff; font-weight:800; letter-spacing:.4px; font-size:16px; cursor:pointer
    }
    .primary[disabled]{opacity:.55; cursor:not-allowed}
    .primary:not([disabled]):hover{background:var(--brand-primary-600)}
    .center{ text-align:center }
    .spinner{ width:56px; height:56px; border-radius:50%; border:4px solid #e5e7eb; border-top-color:var(--brand-primary); animation:spin 1s linear infinite; margin: 0 auto 16px }
    @keyframes spin{to{transform:rotate(360deg)}}
    .success{
      background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46;
      padding:18px; border-radius:14px; margin: 18px 0 8px 0
    }
    .dl{ display:inline-block; padding:12px 18px; border-radius:999px; background:var(--brand-primary); color:#fff; text-decoration:none; font-weight:700 }
    .dl:hover{ background:var(--brand-primary-600) }
    .preview{background:#fff; border:1px solid var(--line); border-radius: var(--radius-xl); margin-top:22px; overflow:hidden}
    .preview-h{background: var(--brand-primary); color:#fff; padding:14px 18px; font-weight:800}
    .preview-c{padding:22px}
    .kpi-grid{display:grid; gap:16px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); margin: 18px 0}
    .kpi{
      background:#fff; border:1px solid var(--line); border-radius:14px; padding:18px; box-shadow: var(--shadow-md)
    }
    .kpi h5{margin:0 0 8px 0; color:#334155; font-size:13px; font-weight:700}
    .kpi .val{font-size:20px; font-weight:900; color: var(--brand-primary)}
    .meta{color:var(--text-subtle); font-size:12px}
    .muted{color:var(--text-subtle)}
    .mt-16{margin-top:16px}
    .mt-24{margin-top:24px}
    .mt-32{margin-top:32px}
    details.testbox{margin-top:6px}
    details.testbox summary{cursor:pointer; font-weight:700}
    details.testbox pre{background:#0f172a; color:#e5e7eb; padding:12px; border-radius:12px; overflow:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="shell">
      <header class="hero" role="banner">
        <div class="brand" aria-label="Arise Tax">ARISE</div>
        <div>
          <h1>QBO Report Package Generator</h1>
          <p>Clean, professional reporting with auto‚Äëcategorization and optional dashboard images.</p>
        </div>
      </header>
      <section class="section">
        <div class="feature-grid">
          <div class="feature">
            <h4>Smart Account Detection</h4>
            <ul>
              <li>P&L vs Balance Sheet auto‚Äësplit</li>
              <li>Revenue / COGS / OpEx recognition</li>
              <li>Other income & expenses grouping</li>
            </ul>
          </div>
          <div class="feature">
            <h4>Visual Integration</h4>
            <ul>
              <li>Drop in PNG/JPG/PDF dashboard charts</li>
              <li>Neat typography & spacing</li>
              <li>On‚Äëbrand color system</li>
            </ul>
          </div>
          <div class="feature">
            <h4>Supported Files</h4>
            <ul>
              <li><strong>Financial:</strong> P&L, Balance Sheet, TB (XLSX/CSV)</li>
              <li><strong>Aging:</strong> A/R & A/P (XLSX/CSV)</li>
              <li><strong>Visuals:</strong> PNG/JPG/PDF exports</li>
            </ul>
          </div>
        </div>
      </section>
      <section class="section">
        <div id="uploadSection" class="drop" role="region" aria-label="Upload files">
          <div style="font-size:46px; margin-bottom:10px">üìé</div>
          <div class="muted" style="font-weight:600; margin-bottom:14px">Drag & drop your QBO files and charts here</div>
          <input type="file" id="fileInput" hidden multiple accept=".xlsx,.xls,.csv,.png,.jpg,.jpeg,.pdf" />
          <button class="u-btn" type="button" onclick="document.getElementById('fileInput').click()">Choose Files</button>
          <div id="fileList" class="file-list"></div>
        </div>
      </section>
      <section class="section">
        <div class="subtle-card">
          <h3 style="margin:0 0 14px 0; color: var(--brand-primary)">Company Information</h3>
          <div class="grid two">
            <div>
              <label for="companyName">Company Name</label>
              <input type="text" id="companyName" placeholder="Enter client company name"/>
            </div>
            <div>
              <label for="reportPeriod">Report Period</label>
              <input type="text" id="reportPeriod" placeholder="e.g., Q1 2025, January 2025"/>
            </div>
            <div>
              <label for="preparedBy">Prepared By</label>
              <input type="text" id="preparedBy" value="Arise Tax Services"/>
            </div>
            <div>
              <label for="reportDate">Date Prepared</label>
              <input type="date" id="reportDate"/>
            </div>
            <div>
              <label for="logoUpload">Upload Company Logo (optional)</label>
              <input type="file" id="logoUpload" accept="image/*"/>
            </div>
            <div>
              <label for="reportNotes">Report Notes (optional)</label>
              <input type="text" id="reportNotes" placeholder="Any special notes or focus areas"/>
            </div>
            <div>
              <label for="pdfAccent">PDF Accent Color</label>
              <input type="color" id="pdfAccent" value="#1e3a8a"/>
            </div>
            <div>
              <label for="pdfTextColor">PDF Text Color</label>
              <input type="color" id="pdfTextColor" value="#1f2937"/>
            </div>
            <div style="grid-column: 1/-1">
              <label for="customRecommendations">Custom Recommendations (optional)</label>
              <textarea id="customRecommendations" placeholder="Enter your professional recommendations and insights for this client‚Ä¶ (one per line)"></textarea>
              <div class="meta mt-16">Tip: Add bullet points (one per line). These will be included in the PDF.</div>
            </div>
          </div>
        </div>
        <button id="generateBtn" class="primary mt-24" onclick="generateReport()" disabled>Generate PDF Report Package</button>
        <details class="testbox mt-16">
          <summary>Diagnostics / Self‚Äëtests</summary>
          <pre id="diagnostics">Idle</pre>
        </details>
      </section>
      <section class="section" id="processing" style="display:none">
        <div class="center">
          <div class="spinner"></div>
          <div class="muted">Analyzing, categorizing, and assembling your report‚Ä¶</div>
        </div>
      </section>
      <section class="section" id="results" style="display:none">
        <div class="success">Report package is ready.</div>
        <a href="#" class="dl" id="downloadPdf">Download PDF</a>
        <div class="preview mt-16" id="reportPreview" style="display:none">
          <div class="preview-h">Preview</div>
          <div class="preview-c" id="previewContent"></div>
        </div>
      </section>
    </div>
  </div>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // ---------- State ----------
    let uploadedFiles = [];
    let parsedData = {};
    let logoDataURL = null;
    let chartImages = [];
    function createEmptyFinancialData(){
      return {
        revenue: {}, costOfGoodsSold: {}, operatingExpenses: {}, otherIncome: {}, otherExpenses: {},
        currentAssets: {}, fixedAssets: {}, otherAssets: {}, currentLiabilities: {}, longTermLiabilities: {}, equity: {},
        totals: {}, balanceSheet: null, arAging: null, apAging: null, charts: chartImages.slice()
      };
    }
    let financialData = createEmptyFinancialData();

const accountClassification = {
  revenue: [/^4\d{3}/i, /revenue/i, /sales/i, /income(?!.*tax)/i, /service.*income/i, /consulting.*income/i, /professional.*fees.*income/i ],
  costOfGoodsSold: [/^5[01]\d{2}/i, /cost.*goods.*sold/i, /cogs/i, /materials/i, /direct.*(cost|labor)/i, /subcontractor/i, /job.*materials/i ],
  operatingExpenses: [/^5[2-9]\d{2}/i, /^6\d{3}/i, /expense/i, /wages|salary/i, /rent|insurance|utilities|office|travel|meals|phone/i, /advertising|marketing|professional.*fees|supplies|repairs|maintenance|depreciation|payroll.*tax|employment.*tax/i ],
  currentAssets: [/^1[01]\d{2}/i, /cash|checking|savings|petty.*cash|undeposited/i, /accounts.*receivable|a\/r|receivable/i, /inventory|prepaid|short.*term.*investment/i ],
  fixedAssets: [/^1[2-9]\d{2}/i, /equipment|furniture|building|land|vehicle|computer|machinery|tools|fixed.*asset|property/i, /accumulated.*depreciation|depreciation/i ],
  currentLiabilities: [/^2[01]\d{2}/i, /accounts.*payable|a\/p|payable|accrued/i, /payroll.*liabilit|employment.*tax|sales.*tax|use.*tax|short.*term.*debt|credit.*card|line.*credit/i ],
  longTermLiabilities: [/^2[2-9]\d{2}/i, /long.*term.*debt|mortgage|loan|note.*payable|bond|lease.*liability|equipment.*loan|vehicle.*loan/i ],
  equity: [/^3\d{3}/i, /equity|capital|retained.*earnings|owner.*equity|partner.*capital|common.*stock|preferred.*stock|drawing|distribution/i ]
};

    // ---------- Boot ----------
    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date();
      const v = today.getFullYear()+ '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
      document.getElementById('reportDate').value = v;
      setupFileUpload();
      setupLogoUpload();
      logDiag('Ready');
    });

    // ---------- Uploads ----------
    function setupFileUpload(){
      const drop = document.getElementById('uploadSection');
      const input = document.getElementById('fileInput');
      ['dragover','dragenter'].forEach(evt => drop.addEventListener(evt, e=>{ e.preventDefault(); drop.classList.add('dragover'); }));
      ['dragleave','drop'].forEach(evt => drop.addEventListener(evt, ()=> drop.classList.remove('dragover')));
      drop.addEventListener('drop', e=>{ e.preventDefault(); handleFiles(e.dataTransfer.files); });
      input.addEventListener('change', e=> handleFiles(e.target.files));
    }
    function setupLogoUpload(){
      document.getElementById('logoUpload').addEventListener('change', e => {
        const file = e.target.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = ev => logoDataURL = ev.target.result;
        r.readAsDataURL(file);
      });
    }
    function handleFiles(files){
      for(let i=0;i<files.length;i++){
        const f = files[i];
        if(!isValidFileType(f)){
          alert(f.name + " is not supported. Upload Excel, CSV, PNG, JPG, or PDF.");
          continue;
        }
        uploadedFiles.push(f);
        renderFileBadge(f);
        if(isImageFile(f) || isPDFFile(f)) processChartFile(f); else parseFinancialFile(f);
      }
      updateGenerateButton();
    }
    function isValidFileType(file){
      const validMimes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','application/vnd.ms-excel','text/csv','application/pdf','image/png','image/jpeg'];
      const validExt = /\\.(xlsx|xls|csv|png|jpg|jpeg|pdf)$/i;
      return validMimes.includes(file.type) || validExt.test(file.name);
    }
    const isImageFile = f => (f.type && f.type.startsWith('image/')) || /\\.(png|jpe?g)$/i.test(f.name||'');
    const isPDFFile = f => (f.type === 'application/pdf') || /\\.pdf$/i.test(f.name||'');
    function renderFileBadge(file){
      const list = document.getElementById('fileList');
      const div = document.createElement('div');
      div.className = 'file';
      div.dataset.filename = file.name;
      const sizeKB = (file.size/1024).toFixed(1);
      const badge = getPill(file.name);
      div.innerHTML = `
        <div style="display:flex; align-items:center; gap:12px">
          <div style="font-size:20px">\${isImageFile(file)||isPDFFile(file)?'üñºÔ∏è':'üìÑ'}</div>
          <div>
            <div style="font-weight:700">\${file.name}</div>
            <div class="meta">\${sizeKB} KB ‚Ä¢ \${describe(file.name)}</div>
          </div>
          \${badge}
        </div>
        <button class="u-btn danger" data-fn="\${file.name}" onclick="removeFile(this.dataset.fn)">Remove</button>
      `;
      list.appendChild(div);
    }
    function getPill(name){
      const n = name.toLowerCase();
       if (name.includes('p&l') || name.includes('profit') || name.includes('income') || 
          name.includes('p l') || name.includes('pl')) {
        return '<span class="file-badge badge-pl">P&L REPORT</span>';
      }
      if (name.includes('balance') && name.includes('sheet')) {
        return '<span class="file-badge badge-bs">BALANCE SHEET</span>';
      }
      if (name.includes('a/r') || name.includes('receivable') || name.includes('ar ')) {
        return '<span class="file-badge badge-ar">A/R AGING</span>';
      }
      if (name.includes('a/p') || name.includes('payable') || name.includes('ap ')) {
        return '<span class="file-badge badge-ap">A/P AGING</span>';
      }
      if (name.includes('trial') && name.includes('balance')) {
        return '<span class="file-badge badge-bs">TRIAL BALANCE</span>';
      }
      
      return '<span class="file-badge badge-pl">FINANCIAL DATA</span>';
    }

    function describe(name){
   if (isImageFile({name: filename, type: ''}) || isPDFFile({name: filename, type: ''})) return 'Dashboard Chart';
      if (name.includes('p&l') || name.includes('profit')) return 'Profit & Loss Report';
      if (name.includes('balance') && name.includes('sheet')) return 'Balance Sheet Report';
      if (name.includes('a/r') || name.includes('receivable')) return 'Accounts Receivable Aging';
      if (name.includes('a/p') || name.includes('payable')) return 'Accounts Payable Aging';
      if (name.includes('trial')) return 'Trial Balance Report';
      
      return 'Financial Report';
    }

    function removeFile(name){
     uploadedFiles = uploadedFiles.filter(f => f.name !== name);
      delete parsedData[name];
      chartImages = chartImages.filter(c => c.name !== name);
      financialData.charts = financialData.charts.filter(c => c.name !== name);
      
      const fileItems = document.querySelectorAll('.file-item');
      fileItems.forEach(item => {
        if (item.dataset.filename === name) {
          item.remove();
        }
      });

    function rebuildFinancialData(){
      financialData = createEmptyFinancialData();
      Object.entries(parsedData).forEach(([fileName, fileData])=>{
        if(fileData) aggregateFinancialEntries(financialData, fileName, fileData);
      });
      calculateTotals();
    }
    function updateGenerateButton(){
      const btn = document.getElementById('generateBtn');
      btn.disabled = uploadedFiles.length===0;
      if (uploadedFiles.length === 0) {
        btn.textContent = 'Generate Enhanced Report Package';
      } else {
        btn.textContent = `Generate Enhanced Report Package (${uploadedFiles.length} files)`;
      }
    }

    function processChartFile(file){
      const r = new FileReader();
      r.onload = e => {
        const obj = { name:file.name, dataURL:e.target.result, type: chartType(file.name), category: chartCategory(file.name) };
        chartImages.push(obj); financialData.charts.push(obj);
      }
      r.readAsDataURL(file);
    }
    const chartType = n => /revenue|sales|income/i.test(n)?'revenue': /expense|cost/i.test(n)?'expense': /cash|flow/i.test(n)?'cashflow': /balance|assets|liabilities/i.test(n)?'balance': /profit|p&l|pl/i.test(n)?'profitloss':'general';
    const chartCategory = n => /dashboard/i.test(n)?'Dashboard': /trend/i.test(n)?'Trend Analysis': /comparison/i.test(n)?'Comparison':'Financial Chart';

   // Enhanced file parsing
    function parseFinancialFile(file) {
      try {
        if (file.name.toLowerCase().includes('csv') || file.type.includes('csv')) {
          const reader = new FileReader();
          reader.onload = e => {
            parsedData[file.name] = parseCSV(e.target.result);
            processFinancialData(file.name, parsedData[file.name]);
          };
          reader.readAsText(file);
        } else {
          const reader = new FileReader();
          reader.onload = e => {
            const workbook = XLSX.read(e.target.result, { type: 'array' });
            parsedData[file.name] = parseExcelWorkbook(workbook);
            processFinancialData(file.name, parsedData[file.name]);
          };
          reader.readAsArrayBuffer(file);
        }
      } catch (err) {
        console.error('Error parsing', file.name, err);
        alert(`Error parsing ${file.name}: ${err.message}`);
      }
    }

    function parseCSV(text) {
      const lines = text.split(/\r?\n/);
      const headers = (lines[0] || '').split(',').map(h => h.trim().replace(/"/g, ''));
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        
        const vals = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        const row = {};
        headers.forEach((h, idx) => row[h] = vals[idx] || '');
        data.push(row);
      }
      
      return { headers, data, type: 'csv' };
    }

    function parseExcelWorkbook(workbook) {
      const result = { sheets: {}, type: 'excel' };
      
      workbook.SheetNames.forEach(name => {
        const ws = workbook.Sheets[name];
        const arr = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
        if (!arr.length) return;
        
        const headers = arr[0] || [];
        const data = [];
        
        for (let r = 1; r < arr.length; r++) {
          const rowArr = arr[r];
          let hasData = false;
          
          for (let c = 0; c < rowArr.length; c++) {
            if (rowArr[c] !== "" && rowArr[c] !== null) {
              hasData = true;
              break;
            }
          }
          
          if (!hasData) continue;
          
          const row = {};
          headers.forEach((h, i) => row[h || ('Column_' + i)] = rowArr[i] || '');
          data.push(row);
        }
        
        result.sheets[name] = { headers, data };
      });
      
      return result;
    }


    // Enhanced account categorization
    function categorizeAccount(accountName) {
      if (!accountName) return 'operatingExpenses';
      
      const name = String(accountName).trim().toLowerCase();
      if (!name) return 'operatingExpenses';
      
      // Check each category pattern
      for (const [category, patterns] of Object.entries(accountClassification)) {
        for (const pattern of patterns) {
          if (pattern.test(name)) {
            return category;
          }
        }
      }
      
      // Fallback categorization based on account numbers
      if (/^1\d{3}/.test(name)) return 'currentAssets';
      if (/^2\d{3}/.test(name)) return 'currentLiabilities';
      if (/^3\d{3}/.test(name)) return 'equity';
      if (/^4\d{3}/.test(name)) return 'revenue';
      if (/^5\d{3}/.test(name)) return 'operatingExpenses';
      if (/^6\d{3}/.test(name)) return 'operatingExpenses';
      
      // Default to operating expenses for unmatched items with amounts
      return 'operatingExpenses';
    }

    function processFinancialData(fileName, fileData) {
      try {
        const data = fileData.type === 'excel'
          ? (Object.values(fileData.sheets)[0]?.data || [])
          : (fileData.data || []);

        data.forEach(row => {
          try {
            const accountName = getAccountName(row);
            const amount = getAmount(row);
            
            if (accountName && amount !== null && Math.abs(amount) > 0.01) {
              const category = categorizeAccount(accountName);
              
              // Store in appropriate category
              if (financialData[category]) {
                financialData[category][accountName] = (financialData[category][accountName] || 0) + amount;
              }
            }
          } catch (rowError) {
            console.warn('Error processing row:', rowError);
          }
        });

        // Process special report types
        processSpecialReports(fileName, fileData);
        calculateTotals();
      } catch (error) {
        console.error('Error in processFinancialData:', error);
      }
    }

    function processSpecialReports(fileName, fileData) {
      try {
        // Balance Sheet detection and processing
        if (!financialData.balanceSheet && isBalanceSheetFile(fileName, fileData)) {
          const sheet = fileData.type === 'excel' ? Object.values(fileData.sheets)[0] : fileData;
          financialData.balanceSheet = processBalanceSheetData(sheet);
        }
        
        // A/R Aging detection and processing
        if (!financialData.arAging && isARAgingFile(fileName, fileData)) {
          const sheet = fileData.type === 'excel' ? Object.values(fileData.sheets)[0] : fileData;
          financialData.arAging = processAgingData(sheet, 'customer');
        }
        
        // A/P Aging detection and processing
        if (!financialData.apAging && isAPAgingFile(fileName, fileData)) {
          const sheet = fileData.type === 'excel' ? Object.values(fileData.sheets)[0] : fileData;
          financialData.apAging = processAgingData(sheet, 'vendor');
        }
      } catch (e) {
        console.warn('Error processing special reports:', e);
      }
    }

    function isBalanceSheetFile(fileName, fileData) {
      const name = fileName.toLowerCase();
      if (name.includes('balance') && name.includes('sheet')) return true;
      
      const headers = getHeaders(fileData);
      return headers.some(h => /assets|liabilities|equity/i.test(String(h)));
    }

    function isARAgingFile(fileName, fileData) {
      const name = fileName.toLowerCase();
      if (name.includes('a/r') || name.includes('receivable')) return true;
      
      const headers = getHeaders(fileData);
      return headers.some(h => /customer/i.test(h)) && 
             headers.some(h => /(1-30|31-60|61-90|current|total|over)/i.test(h));
    }

    function isAPAgingFile(fileName, fileData) {
      const name = fileName.toLowerCase();
      if (name.includes('a/p') || name.includes('payable')) return true;
      
      const headers = getHeaders(fileData);
      return headers.some(h => /vendor/i.test(h)) && 
             headers.some(h => /(1-30|31-60|61-90|current|total|over)/i.test(h));
    }

    function getHeaders(fileData) {
      return fileData.type === 'excel'
        ? (Object.values(fileData.sheets)[0]?.headers || [])
        : (fileData.headers || []);
    }

    function processBalanceSheetData(sheet) {
      const headers = sheet.headers || [];
      const rows = sheet.data || [];
      
      const nameIndex = headers.findIndex(h => /name|account|description/i.test(String(h)));
      const amountIndex = headers.findIndex(h => /amount|total|balance|value/i.test(String(h)));
      
      const processedRows = rows.slice(0, 100).map(row => [
        nameIndex >= 0 ? (row[headers[nameIndex]] || '') : '',
        amountIndex >= 0 ? (row[headers[amountIndex]] || '') : ''
      ]).filter(row => row[0] && row[1]);
      
      return {
        columns: ['Account', 'Amount'],
        rows: processedRows
      };
    }

    function processAgingData(sheet, entityType) {
      const headers = sheet.headers || [];
      const rows = sheet.data || [];
      
      const entityPattern = entityType === 'customer' ? /customer/i : /vendor/i;
      const relevantHeaders = headers.filter(h => 
        entityPattern.test(String(h)) || 
        /(current|1-30|31-60|61-90|over|total)/i.test(String(h))
      );
      
      const processedRows = rows.slice(0, 100).map(row => 
        relevantHeaders.map(header => row[header] || '')
      ).filter(row => row.some(cell => cell));
      
      return {
        columns: relevantHeaders,
        rows: processedRows
      };
    }

    function getAccountName(row) {
      const candidates = ['Name', 'Account', 'Description', 'Account Name', 'Distribution account'];
      
      // Try standard field names first
      for (const field of candidates) {
        if (row[field] && String(row[field]).trim()) {
          return String(row[field]).trim();
        }
      }
      
      // Look for text fields that could be account names
      for (const [key, value] of Object.entries(row)) {
        if (typeof value === 'string' && 
            value.trim() && 
            !value.match(/^\$?[\d,.\-()]+$/) && 
            value.length > 2) {
          return value.trim();
        }
      }
      
      return null;
    }

    function getAmount(row) {
      const candidates = ['Amount', 'Total', 'Balance', 'Value', 'Current', 'Current Period'];
      
      // Try standard amount fields first
      for (const field of candidates) {
        if (row[field] !== undefined && row[field] !== '') {
          const parsed = parseAmount(row[field]);
          if (parsed !== null) return parsed;
        }
      }
      
      // Look for any numeric fields
      for (const value of Object.values(row)) {
        const parsed = parseAmount(value);
        if (parsed !== null && Math.abs(parsed) > 0.01) {
          return parsed;
        }
      }
      
      return null;
    }

    function parseAmount(value) {
      if (typeof value === 'number') return value;
      if (typeof value !== 'string') return null;
      
      const cleaned = value.replace(/[\$,\s]/g, '').trim();
      const isNegative = /\((.*)\)/.test(cleaned);
      const numStr = cleaned.replace(/[()]/g, '');
      const num = parseFloat(numStr);
      
      if (isNaN(num)) return null;
      return isNegative ? -Math.abs(num) : num;
    }

    function calculateTotals() {
      const totalRevenue = sumCategory('revenue') + sumCategory('otherIncome');
      const totalCOGS = sumCategory('costOfGoodsSold');
      const totalOpEx = sumCategory('operatingExpenses') + sumCategory('otherExpenses');
      const totalExpenses = totalCOGS + totalOpEx;
      
      const totalCurrentAssets = sumCategory('currentAssets');
      const totalFixedAssets = sumCategory('fixedAssets');
      const totalAssets = totalCurrentAssets + totalFixedAssets + sumCategory('otherAssets');
      
      const totalCurrentLiabilities = sumCategory('currentLiabilities');
      const totalLongTermLiabilities = sumCategory('longTermLiabilities');
      const totalLiabilities = totalCurrentLiabilities + totalLongTermLiabilities;
      
      const totalEquity = sumCategory('equity');
      
      financialData.totals = {
        totalRevenue,
        totalCOGS,
        grossProfit: totalRevenue - totalCOGS,
        totalOperatingExpenses: totalOpEx,
        totalExpenses,
        netIncome: totalRevenue - totalExpenses,
        totalCurrentAssets,
        totalFixedAssets,
        totalAssets,
        totalCurrentLiabilities,
        totalLongTermLiabilities,
        totalLiabilities,
        totalEquity,
        workingCapital: totalCurrentAssets - totalCurrentLiabilities,
        revenueAccountCount: Object.keys(financialData.revenue).length,
        expenseAccountCount: Object.keys(financialData.operatingExpenses).length + Object.keys(financialData.costOfGoodsSold).length,
        assetAccountCount: Object.keys(financialData.currentAssets).length + Object.keys(financialData.fixedAssets).length,
        chartCount: chartImages.length
      };
    }

    function sumCategory(category) {
      return Object.values(financialData[category] || {}).reduce((sum, val) => sum + (val || 0), 0);
    }


    // ---------- UI: Preview & PDF ----------
    function generateReport(){
      const companyName = document.getElementById('companyName').value.trim();
      const reportPeriod = document.getElementById('reportPeriod').value.trim();
      if (!companyName || !reportPeriod) { alert('Please fill in company name and report period.'); return; }
      document.getElementById('processing').style.display = 'block';
      document.getElementById('generateBtn').disabled = true;
      setTimeout(processReports, 400);
    }
    function processReports(){
      document.getElementById('processing').style.display = 'none';
      document.getElementById('results').style.display = 'block';
      document.getElementById('reportPreview').style.display = 'block';
      const companyName = document.getElementById('companyName').value;
      const reportPeriod = document.getElementById('reportPeriod').value;
      generatePreview(companyName, reportPeriod);
      document.getElementById('downloadPdf').onclick = e => {
        e.preventDefault();
        const fileName = `${companyName.replace(/\s+/g, '_')}_${reportPeriod.replace(/\s+/g, '_')}_Enhanced_Financial_Report`;
        generatePDF(companyName, reportPeriod, fileName);
      };
    }
    function generatePreview(companyName, reportPeriod){
      const el = document.getElementById('previewContent');
      const t = financialData.totals;
      const logo = logoDataURL
        ? `<img src="\${logoDataURL}" style="max-width:150px;max-height:80px;margin-bottom:20px;border-radius:8px;"/>`
        : '<div style="background:linear-gradient(135deg,#4a4fb5,#3e3b8c);color:#fff;padding:15px 25px;border-radius:8px;display:inline-block;margin-bottom:20px;font-weight:bold;">ARISE TAX</div>';
      const recos = (document.getElementById('customRecommendations').value || '')
        .split(/\\n+/).map(s=>s.trim()).filter(Boolean);
      const recosHtml = recos.length ? ('<ul>' + recos.map(r=>'<li>'+escapeHtml(r)+'</li>').join('') + '</ul>') : '<p class="muted">No custom recommendations added.</p>';
      
      el.innerHTML = `
        <div style="text-align:center;margin-bottom:40px;padding:40px;background:linear-gradient(135deg,#4a4fb5,#3e3b8c);color:#fff;border-radius:15px;">
          \${logo}
          <h1 style="margin:15px 0;">Financial Report Package</h1>
          <h2 style="margin:10px 0;">\${companyName}</h2>
          <h3 style="margin:10px 0;">\${reportPeriod}</h3>
          <p style="opacity:0.9;">Prepared by \${document.getElementById('preparedBy').value} ‚Äî \${document.getElementById('reportDate').value}</p>
        </div>
        <div class="kpi-grid">
          <div class="kpi"><h5>Total Revenue</h5><div class="val">\${formatCurrency(t.totalRevenue||0)}</div><div class="meta">\${t.revenueAccountCount} streams</div></div>
          <div class="kpi"><h5>Gross Profit</h5><div class="val">\${formatCurrency((t.grossProfit)||0)}</div><div class="meta">\${pct(t.grossProfit, t.totalRevenue)} margin</div></div>
          <div class="kpi"><h5>Net Income</h5><div class="val">\${formatCurrency(t.netIncome||0)}</div><div class="meta">\${pct(t.netIncome, t.totalRevenue)} of revenue</div></div>
          <div class="kpi"><h5>Working Capital</h5><div class="val">\${formatCurrency(t.workingCapital||0)}</div><div class="meta">CA - CL</div></div>
        </div>
        <div class="mt-24">
          <h3 style="margin:0 0 12px 0;color:#111827">Recommendations</h3>
          \${recosHtml}
        </div>
      `;
    }
    function pct(n,d){ if(!d) return '‚Äî'; return (100 * (n||0)/d).toFixed(1)+'%'; }
    function formatCurrency(v){ const n = Number(v||0); return n.toLocaleString(undefined, {style:'currency', currency:'USD'}); }
    function escapeHtml(s){ return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function colorFromInput(id, fallback){ const el = document.getElementById(id); return (el && el.value) ? el.value : fallback; }

    // Report generation
    function generateReport() {
      const companyName = document.getElementById('companyName').value.trim();
      const reportPeriod = document.getElementById('reportPeriod').value.trim();
      
      if (!companyName || !reportPeriod) {
        alert('Please fill in company name and report period.');
        return;
      }
      
      document.getElementById('processing').style.display = 'block';
      document.getElementById('generateBtn').disabled = true;
      
      // Add slight delay for UX
      setTimeout(processReports, 600);
    }

    function processReports() {
      document.getElementById('processing').style.display = 'none';
      document.getElementById('results').style.display = 'block';
      document.getElementById('reportPreview').style.display = 'block';

      const companyName = document.getElementById('companyName').value;
      const reportPeriod = document.getElementById('reportPeriod').value;

      generatePreview(companyName, reportPeriod);
      
       document.getElementById('downloadPdf').onclick = e => {
        e.preventDefault();
        const fileName = `${companyName.replace(/\s+/g, '_')}_${reportPeriod.replace(/\s+/g, '_')}_Enhanced_Financial_Report`;
        generatePDF(companyName, reportPeriod, fileName);
      };
    }

    function generatePreview(companyName, reportPeriod) {
      const el = document.getElementById('previewContent');
      const totals = financialData.totals;
      
      const logo = logoDataURL
        ? `<img src="${logoDataURL}" style="max-width:150px;max-height:80px;margin-bottom:20px;border-radius:8px;"/>`
        : '<div style="background:linear-gradient(135deg,#4a4fb5,#3e3b8c);color:#fff;padding:15px 25px;border-radius:8px;display:inline-block;margin-bottom:20px;font-weight:bold;">ARISE TAX</div>';
      
      const profitabilityStatus = totals.netIncome >= 0 ? 
        { color: '#22c55e', status: 'Profitable', message: 'Strong financial performance' } :
        { color: '#ef4444', status: 'Loss', message: 'Review required' };

      el.innerHTML = `
        <div style="text-align:center;margin-bottom:40px;padding:40px;background:linear-gradient(135deg,#4a4fb5,#3e3b8c);color:#fff;border-radius:15px;">
          ${logo}
          <h1 style="margin:15px 0;">Enhanced Financial Report Package</h1>
          <h2 style="margin:10px 0;">${companyName}</h2>
          <h3 style="margin:10px 0;">${reportPeriod}</h3>
          <p style="opacity:0.9;">Prepared by ${document.getElementById('preparedBy').value}</p>
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:25px;margin:40px 0;">
          <div style="background:linear-gradient(135deg,#22c55e,#16a34a);color:white;padding:25px;border-radius:15px;text-align:center;box-shadow:0 4px 15px rgba(34,197,94,0.3);">
            <h4 style="margin:0 0 10px 0;opacity:0.9;">Total Revenue</h4>
            <h2 style="margin:0 0 8px 0;">${formatCurrency(totals.totalRevenue || 0)}</h2>
            <small>${totals.revenueAccountCount} revenue streams</small>
          </div>
          <div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:25px;border-radius:15px;text-align:center;box-shadow:0 4px 15px rgba(245,158,11,0.3);">
            <h4 style="margin:0 0 10px 0;opacity:0.9;">Gross Profit</h4>
            <h2 style="margin:0 0 8px 0;">${formatCurrency(totals.grossProfit || 0)}</h2>
            <small>${totals.totalRevenue > 0 ? ((totals.grossProfit / totals.totalRevenue) * 100).toFixed(1) : '0.0'}% margin</small>
          </div>
          <div style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;padding:25px;border-radius:15px;text-align:center;box-shadow:0 4px 15px rgba(59,130,246,0.3);">
            <h4 style="margin:0 0 10px 0;opacity:0.9;">Total Expenses</h4>
            <h2 style="margin:0 0 8px 0;">${formatCurrency(totals.totalExpenses || 0)}</h2>
            <small>${totals.expenseAccountCount} expense categories</small>
          </div>
          <div style="background:linear-gradient(135deg,${profitabilityStatus.color},${profitabilityStatus.color}dd);color:white;padding:25px;border-radius:15px;text-align:center;box-shadow:0 4px 15px ${profitabilityStatus.color}50;">
            <h4 style="margin:0 0 10px 0;opacity:0.9;">Net Income</h4>
            <h2 style="margin:0 0 8px 0;">${formatCurrency(totals.netIncome || 0)}</h2>
            <small>${profitabilityStatus.status}</small>
          </div>
        </div>
        
        <div style="background:linear-gradient(135deg,#f8fafc,#f1f5f9);padding:30px;border-left:6px solid #4a4fb5;border-radius:0 15px 15px 0;margin:30px 0;">
          <h3 style="color:#4a4fb5;margin-bottom:20px;">Enhanced Analysis Summary</h3>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;">
            <div>
              <strong style="color:#374151;">Account Categorization</strong><br/>
              <span style="color:#6b7280;">Revenue: ${totals.revenueAccountCount}</span><br/>
              <span style="color:#6b7280;">Expenses: ${totals.expenseAccountCount}</span><br/>
              <span style="color:#6b7280;">Assets: ${totals.assetAccountCount}</span>
            </div>
            <div>
              <strong style="color:#374151;">Balance Sheet Health</strong><br/>
              <span style="color:#6b7280;">Total Assets: ${formatCurrency(totals.totalAssets || 0)}</span><br/>
              <span style="color:#6b7280;">Working Capital: ${formatCurrency(totals.workingCapital || 0)}</span>
            </div>
            <div>
              <strong style="color:#374151;">Visual Analytics</strong><br/>
              <span style="color:#6b7280;">Dashboard Charts: ${totals.chartCount}</span><br/>
              <span style="color:#6b7280;">Special Reports: ${getSpecialReportCount()}</span>
            </div>
          </div>
        </div>
        
        ${totals.chartCount > 0 ? `
          <div style="background:linear-gradient(135deg,#ecfdf5,#d1fae5);padding:25px;border-left:6px solid #22c55e;border-radius:0 15px 15px 0;margin:25px 0;">
            <h3 style="color:#22c55e;margin-bottom:15px;">Dashboard Charts Integrated</h3>
            ${chartImages.map(chart => `<p style="margin:5px 0;color:#374151;">‚Ä¢ ${chart.name} (${chart.category})</p>`).join('')}
          </div>
        ` : ''}
        
        <div style="background:${profitabilityStatus.color}20;padding:25px;border-left:6px solid ${profitabilityStatus.color};border-radius:0 15px 15px 0;margin:25px 0;">
          <h3 style="color:${profitabilityStatus.color};margin-bottom:10px;">Financial Health Status</h3>
          <p style="color:#374151;">${profitabilityStatus.message} - ${getHealthRecommendation()}</p>
        </div>
      `;
    }

    function getSpecialReportCount() {
      let count = 0;
      if (financialData.balanceSheet) count++;
      if (financialData.arAging) count++;
      if (financialData.apAging) count++;
      return count;
    }

    function getHealthRecommendation() {
      const totals = financialData.totals;
      if (totals.netIncome >= 0) {
        if (totals.grossProfit / totals.totalRevenue > 0.5) {
          return "Excellent margins and profitability. Consider growth opportunities.";
        }
        return "Positive performance. Monitor expense efficiency and scaling opportunities.";
      } else {
        if (totals.totalRevenue > 0) {
          return "Revenue present but expenses exceed income. Focus on cost reduction and revenue optimization.";
        }
        return "Comprehensive financial review needed. Analyze revenue generation and expense structure.";
      }
    }

    function formatCurrency(amount) {
      const abs = Math.abs(amount);
      const formatted = abs.toLocaleString('en-US', { 
        style: 'currency', 
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0 
      });
      return amount < 0 ? `(${formatted})` : formatted;
    }

    // Enhanced PDF Generation
    function generatePDF(companyName, reportPeriod, fileName) {
      const doc = new window.jspdf.jsPDF({ unit: 'mm', format: 'a4' });
      const ariseBlue = [74, 79, 181];
      const lightBlue = [240, 242, 255];
      
      // Helper functions for PDF generation
      function addHeader(title) {
        doc.setFillColor(ariseBlue[0], ariseBlue[1], ariseBlue[2]);
        doc.rect(0, 0, 210, 35, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(18);
        doc.text(title, 105, 22, { align: 'center' });
      }
      
      function addKPICard(x, y, title, value, color) {
        const rgb = hexToRgb(color);
        // Shadow
        doc.setFillColor(200, 200, 200);
        doc.roundedRect(x + 2, y + 2, 85, 40, 3, 3, 'F');
        // Main card
        doc.setFillColor(255, 255, 255);
        doc.setDrawColor(rgb.r, rgb.g, rgb.b);
        doc.setLineWidth(1.5);
        doc.roundedRect(x, y, 85, 40, 3, 3, 'FD');
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(100, 100, 100);
        doc.text(title, x + 6, y + 12);
        
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(rgb.r, rgb.g, rgb.b);
        doc.text(String(value), x + 6, y + 28);
      }
     
      function addTable(startX, startY, columns, rows, options = {}) {
        const opts = {
          headerColor: '#4a4fb5',
          rowHeight: 10,
          fontSize: 8,
          maxWidth: 170,
          alignRight: [],
          ...options
        };
        
        const colWidth = opts.maxWidth / columns.length;
        let y = startY;
        
        // Header
        const headerRgb = hexToRgb(opts.headerColor);
        doc.setFillColor(headerRgb.r, headerRgb.g, headerRgb.b);
        doc.rect(startX, y - 8, opts.maxWidth, 12, 'F');
        
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.setTextColor(255, 255, 255);
        
        columns.forEach((col, i) => {
          const x = startX + (i * colWidth) + 3;
          const align = opts.alignRight.includes(i) ? 'right' : 'left';
          const textX = align === 'right' ? x + colWidth - 6 : x;
          doc.text(String(col), textX, y, { align });
        });
        
        y += 8;
        
        // Rows
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(opts.fontSize);
        doc.setTextColor(31, 41, 55);
        
        const maxRows = Math.min(rows.length, 25);
        for (let rowIdx = 0; rowIdx < maxRows; rowIdx++) {
          const row = rows[rowIdx];
          
          if (rowIdx % 2 === 0) {
            doc.setFillColor(248, 250, 252);
            doc.rect(startX, y - 6, opts.maxWidth, opts.rowHeight, 'F');
          }
          
          row.forEach((cell, i) => {
            const x = startX + (i * colWidth) + 3;
            const align = opts.alignRight.includes(i) ? 'right' : 'left';
            const textX = align === 'right' ? x + colWidth - 6 : x;
            const cellText = String(cell || '').slice(0, 30);
            doc.text(cellText, textX, y, { align });
          });
          
          y += opts.rowHeight;
          
          if (y > 250) break;
        }
        
        return y;
      }
      
      function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
          r: parseInt(result[1], 16),
          g: parseInt(result[2], 16),
          b: parseInt(result[3], 16)
        } : { r: 74, g: 79, b: 181 };
      }
      
      // PAGE 1: Cover Page
      doc.setFillColor(ariseBlue[0], ariseBlue[1], ariseBlue[2]);
      doc.rect(0, 0, 210, 30, 'F');
      
      // Logo area
      doc.setFillColor(lightBlue[0], lightBlue[1], lightBlue[2]);
      doc.rect(60, 50, 90, 50, 'F');
      doc.setDrawColor(200, 200, 200);
      doc.rect(60, 50, 90, 50, 'S');
      
      if (logoDataURL) {
        try {
          doc.addImage(logoDataURL, 'JPEG', 70, 60, 70, 30);
        } catch (e) {
          doc.setTextColor(ariseBlue[0], ariseBlue[1], ariseBlue[2]);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(20);
          doc.text('ARISE TAX', 105, 78, { align: 'center' });
        }
      } else {
        doc.setTextColor(ariseBlue[0], ariseBlue[1], ariseBlue[2]);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(20);
        doc.text('ARISE TAX', 105, 78, { align: 'center' });
      }
      
      doc.setTextColor(ariseBlue[0], ariseBlue[1], ariseBlue[2]);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(24);
      doc.text('Enhanced Financial Report', 105, 130, { align: 'center' });
      
      doc.setTextColor(60, 60, 60);
      doc.setFontSize(18);
      doc.text(companyName, 105, 150, { align: 'center' });
      doc.setFontSize(14);
      doc.text(reportPeriod, 105, 165, { align: 'center' });
      
      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      doc.text('Prepared by: ' + document.getElementById('preparedBy').value, 105, 220, { align: 'center' });
      doc.text('Date: ' + new Date().toLocaleDateString(), 105, 230, { align: 'center' });
      
      doc.setFillColor(ariseBlue[0], ariseBlue[1], ariseBlue[2]);
      doc.rect(0, 270, 210, 27, 'F');
      
      // PAGE 2: Executive Summary
      doc.addPage();
      addHeader('Executive Summary');
      
      const totals = financialData.totals;
      let y = 55;
      
      // KPI Cards
      addKPICard(15, y, 'Total Revenue', formatCurrency(totals.totalRevenue || 0), '#22c55e');
      addKPICard(110, y, 'Gross Profit', formatCurrency(totals.grossProfit || 0), '#3b82f6');
      
      y += 50;
      addKPICard(15, y, 'Total Expenses', formatCurrency(totals.totalExpenses || 0), '#f59e0b');
      addKPICard(110, y, 'Net Income', formatCurrency(totals.netIncome || 0), totals.netIncome >= 0 ? '#22c55e' : '#ef4444');
      
      y += 60;
      
      // Summary stats
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.setTextColor(ariseBlue[0], ariseBlue[1], ariseBlue[2]);
      doc.text('Financial Overview', 20, y);
      y += 15;
      
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.setTextColor(55, 65, 81);
      
      const summaryItems = [
        `Revenue Accounts: ${totals.revenueAccountCount}`,
        `Expense Accounts: ${totals.expenseAccountCount}`,
        `Total Assets: ${formatCurrency(totals.totalAssets || 0)}`,
        `Working Capital: ${formatCurrency(totals.workingCapital || 0)}`,
        `Gross Margin: ${totals.totalRevenue > 0 ? ((totals.grossProfit / totals.totalRevenue) * 100).toFixed(1) : '0.0'}%`
      ];
      
      summaryItems.forEach(item => {
        doc.text(`‚Ä¢ ${item}`, 25, y);
        y += 8;
      });
      
      y += 15;
      
      // Health indicator
      const isProfit = totals.netIncome >= 0;
      doc.setFillColor(isProfit ? 220 : 254, isProfit ? 252 : 226, isProfit ? 231 : 226);
      doc.rect(20, y - 10, 170, 25, 'F');
      doc.setDrawColor(isProfit ? 34 : 239, isProfit ? 197 : 68, isProfit ? 94 : 68);
      doc.rect(20, y - 10, 170, 25, 'S');
      
      doc.setTextColor(isProfit ? 34 : 239, isProfit ? 197 : 68, isProfit ? 94 : 68);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text(isProfit ? 'Profitable Operations' : 'Operating at a Loss', 25, y);
      
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      doc.setTextColor(55, 65, 81);
      const healthMsg = isProfit ? 'Strong financial performance with positive net income' : 'Immediate attention required - review expense structure and revenue optimization';
      doc.text(healthMsg, 25, y + 8);
      
      // PAGE 3: Revenue Analysis
      if (Object.keys(financialData.revenue).length > 0) {
        doc.addPage();
        addHeader('Revenue Analysis');
        
        const revenueEntries = Object.entries(financialData.revenue).sort((a, b) => b[1] - a[1]);
        const revenueTotal = totals.totalRevenue || 0;
        
        const revenueRows = revenueEntries.slice(0, 20).map(([name, amount]) => {
          const percentage = revenueTotal > 0 ? (amount / revenueTotal * 100) : 0;
          return [
            name.slice(0, 40),
            formatCurrency(amount),
            percentage.toFixed(1) + '%'
          ];
        });
        
        addTable(20, 60, ['Revenue Source', 'Amount', '% Share'], revenueRows, {
          alignRight: [1, 2],
          headerColor: '#22c55e'
        });
      }
      
      // PAGE 4: Expense Analysis  
      if (totals.expenseAccountCount > 0) {
        doc.addPage();
        addHeader('Expense Analysis');
        
        const allExpenses = {
          ...financialData.operatingExpenses,
          ...financialData.costOfGoodsSold,
          ...financialData.otherExpenses
        };
        
        const expenseEntries = Object.entries(allExpenses).sort((a, b) => b[1] - a[1]);
        const expenseTotal = totals.totalExpenses || 0;
        
        const expenseRows = expenseEntries.slice(0, 20).map(([name, amount]) => {
          const percentage = expenseTotal > 0 ? (amount / expenseTotal * 100) : 0;
          return [
            name.slice(0, 40),
            formatCurrency(amount),
            percentage.toFixed(1) + '%'
          ];
        });
        
        addTable(20, 60, ['Expense Category', 'Amount', '% Share'], expenseRows, {
          alignRight: [1, 2],
          headerColor: '#3b82f6'
        });
      }
      
      // PAGE 5: Balance Sheet Analysis
      if (totals.totalAssets > 0) {
        doc.addPage();
        addHeader('Balance Sheet Analysis');
        
        let y = 50;
        
        // Assets section
        if (Object.keys(financialData.currentAssets).length > 0 || Object.keys(financialData.fixedAssets).length > 0) {
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(12);
          doc.setTextColor(ariseBlue[0], ariseBlue[1], ariseBlue[2]);
          doc.text('ASSETS', 20, y);
          y += 10;
          
          // Current Assets
          if (Object.keys(financialData.currentAssets).length > 0) {
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('Current Assets', 25, y);
            y += 8;
            
            Object.entries(financialData.currentAssets).slice(0, 10).forEach(([name, amount]) => {
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(9);
              doc.setTextColor(55, 65, 81);
              doc.text(name.slice(0, 45), 30, y);
              doc.text(formatCurrency(amount), 180, y, { align: 'right' });
              y += 7;
            });
            y += 5;
          }
          
          // Fixed Assets  
          if (Object.keys(financialData.fixedAssets).length > 0) {
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.setTextColor(ariseBlue[0], ariseBlue[1], ariseBlue[2]);
            doc.text('Fixed Assets', 25, y);
            y += 8;
            
            Object.entries(financialData.fixedAssets).slice(0, 10).forEach(([name, amount]) => {
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(9);
              doc.setTextColor(55, 65, 81);
              doc.text(name.slice(0, 45), 30, y);
              doc.text(formatCurrency(amount), 180, y, { align: 'right' });
              y += 7;
            });
            y += 10;
          }
          
          // Total Assets
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(11);
          doc.setTextColor(ariseBlue[0], ariseBlue[1], ariseBlue[2]);
          doc.text('Total Assets', 25, y);
          doc.text(formatCurrency(totals.totalAssets), 180, y, { align: 'right' });
          y += 15;
        }
        
        // Liabilities section
        if (Object.keys(financialData.currentLiabilities).length > 0 || Object.keys(financialData.longTermLiabilities).length > 0) {
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(12);
          doc.setTextColor(ariseBlue[0], ariseBlue[1], ariseBlue[2]);
          doc.text('LIABILITIES', 20, y);
          y += 10;
          
          // Current Liabilities
          if (Object.keys(financialData.currentLiabilities).length > 0) {
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('Current Liabilities', 25, y);
            y += 8;
            
            Object.entries(financialData.currentLiabilities).slice(0, 8).forEach(([name, amount]) => {
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(9);
              doc.setTextColor(55, 65, 81);
              doc.text(name.slice(0, 45), 30, y);
              doc.text(formatCurrency(amount), 180, y, { align: 'right' });
              y += 7;
            });
          }
        }
      }
      
      // Add special reports if available
      if (financialData.arAging) {
        doc.addPage();
        addHeader('Accounts Receivable Aging');
        addTable(20, 60, financialData.arAging.columns, financialData.arAging.rows, {
          headerColor: '#f59e0b',
          alignRight: [1, 2, 3, 4, 5]
        });
      }
      
      if (financialData.apAging) {
        doc.addPage();
        addHeader('Accounts Payable Aging');
        addTable(20, 60, financialData.apAging.columns, financialData.apAging.rows, {
          headerColor: '#ef4444',
          alignRight: [1, 2, 3, 4, 5]
        });
      }
      
      // PAGE: Recommendations
      doc.addPage();
      addHeader('Recommendations & Action Items');
      
      y = 50;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.setTextColor(ariseBlue[0], ariseBlue[1], ariseBlue[2]);
      doc.text('Key Findings & Recommendations', 20, y);
      y += 15;
      
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.setTextColor(55, 65, 81);
      
      const recommendations = getDetailedRecommendations();
      recommendations.forEach(rec => {
        doc.text(`‚Ä¢ ${rec}`, 25, y);
        y += 8;
        if (y > 250) {
          doc.addPage();
          y = 50;
        }
      });
      
      // Footer on last page
      doc.setFillColor(ariseBlue[0], ariseBlue[1], ariseBlue[2]);
      doc.rect(0, 270, 210, 27, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(10);
      doc.text('Confidential - Prepared by ' + document.getElementById('preparedBy').value, 105, 285, { align: 'center' });
      
      // Save the PDF
      doc.save(`${fileName}.pdf`);
    }
    
     // ===== RECOMMENDATIONS PAGE =====

      function getDetailedRecommendations() {
    
  	// First check if user provided custom recommendations
     
	 const customRecs = document.getElementById('customRecommendations').value.trim();
      if (customRecs) {
        return customRecs.split('\n').filter(line => line.trim()).map(line => line.trim());
      }
      
      // Fallback to generated recommendations if no custom input
      const totals = financialData.totals;
      const recommendations = [];
      
      if (totals.netIncome < 0) {
        recommendations.push('Immediate action required: Company is operating at a loss');
        recommendations.push('Conduct detailed expense review to identify cost reduction opportunities');
        recommendations.push('Analyze revenue streams for growth and optimization potential');
      } else {
        recommendations.push('Company shows positive profitability - consider growth strategies');
      }
      
      if (totals.grossProfit / totals.totalRevenue < 0.3) {
        recommendations.push('Gross margin below 30% - review pricing strategy and cost of goods sold');
      }
      
      if (totals.workingCapital < 0) {
        recommendations.push('Negative working capital indicates potential cash flow concerns');
      }
      
      if (totals.revenueAccountCount < 3) {
        recommendations.push('Limited revenue diversification - consider expanding income sources');
      }
      
      if (totals.expenseAccountCount > 50) {
        recommendations.push('High number of expense categories - consider consolidation for better tracking');
      }
      
      recommendations.push('Regular monthly financial review recommended');
      recommendations.push('Consider implementing cash flow forecasting');
      recommendations.push('Review and update chart of accounts for better categorization');
      
      return recommendations;
    }
  </script>
</body>
</html>
